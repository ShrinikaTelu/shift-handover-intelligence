version: '3.8'

services:
    backend:
        build:
            context: .
            dockerfile: Dockerfile.backend
        container_name: handover-backend
        ports:
            - '8000:8000'
        environment:
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - DATABASE_URL=${DATABASE_URL:-sqlite+aiosqlite:///./handover.db}
            - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:4200,http://localhost}
            - DEBUG=${DEBUG:-false}
            - LOG_LEVEL=${LOG_LEVEL:-INFO}
        volumes:
            - ./backend:/app
            - backend-data:/app/data
        restart: unless-stopped
        networks:
            - handover-network
        healthcheck:
            test:
                [
                    'CMD',
                    'python',
                    '-c',
                    "import requests; requests.get('http://localhost:8000/health')",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 5s

    frontend:
        build:
            context: .
            dockerfile: Dockerfile.frontend
        container_name: handover-frontend
        ports:
            - '80:80'
        depends_on:
            - backend
        restart: unless-stopped
        networks:
            - handover-network
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--quiet',
                    '--tries=1',
                    '--spider',
                    'http://localhost/',
                ]
            interval: 30s
            timeout: 3s
            retries: 3

volumes:
    backend-data:
        driver: local

networks:
    handover-network:
        driver: bridge
